doctype html
html
  head
    title Buscador
    meta(charset='utf-8')
    meta(name='viewport', content='width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1')
    link(rel='stylesheet' href='https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap')
    link(rel="stylesheet", href="/stylesheets/index.css")
    link(rel="stylesheet", href="/stylesheets/sidebar.css")
    link(rel="stylesheet", href="/stylesheets/estructura.css")
    link(rel="stylesheet", href="/stylesheets/header.css")
    link(rel="stylesheet", href="/stylesheets/formulario.css")
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    link(rel='icon' href='https://images.vexels.com/media/users/3/196341/isolated/preview/f00a8411a0fd49550fd3fd6e42638bfb-lupa-plana.png')
  body
    include messages
    block content
    script(src='https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js')
    script(src='https://cdn.jsdelivr.net/npm/instantsearch.js@4')
    script.
      // Manejo del sidebar responsive
      function initializeSidebar() {
        const toggleButton = document.getElementById('toggle-sidebar');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        
        if (!toggleButton || !sidebar || !mainContent) {
          console.log('No se encontraron los elementos necesarios');
          return;
        }

        // Función para verificar si estamos en modo móvil
        const isMobileView = () => window.innerWidth <= 768;

        // Función para actualizar el estado inicial
        const updateInitialState = () => {
          if (isMobileView()) {
            sidebar.style.transform = 'translateX(-100%)';
            mainContent.style.marginLeft = '0';
            toggleButton.style.display = 'block';
          } else {
            sidebar.style.transform = 'translateX(0)';
            mainContent.style.marginLeft = '300px';
            toggleButton.style.display = 'none';
          }
        };

        // Toggle del sidebar
        toggleButton.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (sidebar.style.transform === 'translateX(0px)') {
            sidebar.style.transform = 'translateX(-100%)';
            mainContent.classList.remove('shifted');
          } else {
            sidebar.style.transform = 'translateX(0)';
            mainContent.classList.add('shifted');
          }
        });

        // Cerrar el sidebar al hacer clic fuera
        document.addEventListener('click', (event) => {
          if (isMobileView() && 
              sidebar.style.transform === 'translateX(0px)' && 
              !sidebar.contains(event.target) && 
              !toggleButton.contains(event.target)) {
            sidebar.style.transform = 'translateX(-100%)';
            mainContent.classList.remove('shifted');
          }
        });

        // Manejar cambios de tamaño de ventana
        window.addEventListener('resize', updateInitialState);

        // Establecer estado inicial
        updateInitialState();
      }

      // Inicializar el sidebar cuando el DOM esté listo
      document.addEventListener('DOMContentLoaded', initializeSidebar);

      // Inicializar la búsqueda si estamos en la página de búsqueda
      if (document.getElementById('searchbox')) {
        const search = instantsearch({
          indexName: "Proyectos",
          searchClient: instantMeiliSearch(
            "http://localhost:7700"
          ).searchClient
        });

        search.addWidgets([
          instantsearch.widgets.searchBox({
            container: "#searchbox",
            placeholder: "Buscar..."
          }),
          instantsearch.widgets.configure({ 
            hitsPerPage: 10
          }),
          instantsearch.widgets.hits({
            container: "#hits",
            templates: {
              item: `
              <div class="proyecto">
                <div class="hit-name">
                    {{#helpers.highlight}}{ "attribute": "nombre" }{{/helpers.highlight}}
                </div>
                <div class="hit-description">
                    <span class="fixed-text">Estado</span>
                    {{#helpers.highlight}}{ "attribute": "estatus" }{{/helpers.highlight}}
                </div>
                <div class="hit-description">
                    <span class="fixed-text">Ubicación</span>
                    {{#helpers.highlight}}{ "attribute": "basedOn" }{{/helpers.highlight}}
                </div>
                <div class="hit-description">
                    <span class="fixed-text">Área</span>
                    {{#helpers.highlight}}{ "attribute": "granArea1" }{{/helpers.highlight}}
                </div>
                <div class="hit-description">
                    <span class="fixed-text">Tipo</span>
                    {{#helpers.highlight}}{ "attribute": "tipo" }{{/helpers.highlight}}
                </div>
              </div>
              `
            }
          })
        ]);

        search.start();

        document.querySelectorAll('.filterCheckbox').forEach(function(checkbox) {
          checkbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.filterCheckbox');
            let filters = [];

            checkboxes.forEach(function(cb) {
              if (cb.checked) {
                filters.push(`${cb.dataset.filter} = "${cb.value}"`);
              }
            });

            search.addWidgets([
              instantsearch.widgets.configure({
                filters: filters.join(' AND ')
              }),
            ]);

            search.refresh();
          });
        });
      }
